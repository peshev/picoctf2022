#!/usr/bin/env python3

import socket
from pexpect import fdpexpect

import sys

sys.path.insert(1, '../..')
from utils import download_artifacts

download_artifacts()

choice_regex = br"Type '(?P<choice>\d+)' to (?P<action>.+?)\r\n"
with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.connect(("saturn.picoctf.net", 50305))
    session = fdpexpect.fdspawn(s.fileno(), timeout=10)
    choices = {}
    while True:
        session.expect(choice_regex)
        match = session.match.groupdict()
        choices[match["action"]] = match["choice"]
        if match["action"] == b'exit the program':
            break
    for _ in range(5):
        session.write(choices[b"play a game"] + b"\n")
        session.expect(rb"Please make your selection \((?P<moves>.+)\):")
        match = session.match.groupdict()
        session.write(match["moves"].replace(b"/", b"") + b"\n")
    session.expect(rb"picoCTF\{.+}")
    print(session.match.group(0).decode())
