#!/usr/bin/env python3

import requests
from os.path import isfile
import subprocess
from urllib.parse import urljoin
import json

year = 2021
feed_base_url = "https://nvd.nist.gov/feeds/json/cve/1.1/"
filename = f"nvdcve-1.1-{year}"
download = True

if isfile(filename + ".json.gz"):
    try:
        # I'm using the gunzip command instead of the gzip module to make it understandable for non-python people
        subprocess.check_output(["gunzip", "-f", filename + ".json.gz"])
    except subprocess.CalledProcessError:
        pass

if isfile(filename + ".json"):
    # I'm using the sha256sum command instead of the hashlib module to make it understandable for non-python people
    output = subprocess.check_output(["sha256sum", filename + ".json"])
    checksum = output.split()[0].decode()
    meta = {
        k: v
        for k, v in
        (
            line.split(":", maxsplit=1)
            for line in
            filter(None, map(
                str.strip, requests.get(urljoin(feed_base_url, filename + ".meta")).text.split("\n")))
        )
    }
    if meta["sha256"].upper() == checksum.upper():
        download = False

if download:
    resp = requests.get(urljoin(feed_base_url, filename + ".json.gz"))
    with open(filename + ".json.gz", "wb") as fp:
        fp.write(resp.content)
    subprocess.check_output(["gunzip", "-f", filename + ".json.gz"])

with open(filename + ".json") as fp:
    feed = json.load(fp)

ids = [
    i["cve"]["CVE_data_meta"]["ID"]
    for i in
    feed["CVE_Items"]
    if any(
        (
                "windows" in d["value"].lower() and
                "print spooler" in d["value"].lower() and
                (
                        "rce" in d["value"].lower() or
                        "remote code execution" in d["value"].lower()
                )
        )
        for d in
        i["cve"]["description"]["description_data"]
    )
]
print(f"picoCTF{{{ids[0]}}}")
